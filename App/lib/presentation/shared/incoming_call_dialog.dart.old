import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

/// Incoming Call Dialog - Hiện khi có cuộc gọi đến
/// UI giống Messenger: Avatar to, 2 button tròn accept/decline
class IncomingCallDialog extends StatelessWidget {
  final String callerName;
  final String? callerAvatar;
  final String callType; // 'video' or 'audio'
  final VoidCallback onAccept;
  final VoidCallback onDecline;

  const IncomingCallDialog({
    Key? key,
    required this.callerName,
    this.callerAvatar,
    this.callType = 'video',
    required this.onAccept,
    required this.onDecline,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      elevation: 0,
      child: Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.3),
              blurRadius: 20,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Avatar
            Container(
              width: 120,
              height: 120,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                gradient: LinearGradient(
                  colors: [
                    const Color(0xFF2DD4BF),
                    const Color(0xFF06B6D4),
                  ],
                ),
                boxShadow: [
                  BoxShadow(
                    color: const Color(0xFF06B6D4).withOpacity(0.3),
                    blurRadius: 20,
                    offset: const Offset(0, 5),
                  ),
                ],
              ),
              child: callerAvatar != null && callerAvatar!.isNotEmpty
                  ? ClipOval(
                      child: Image.network(
                        callerAvatar!,
                        fit: BoxFit.cover,
                        errorBuilder: (_, __, ___) => _buildDefaultAvatar(),
                      ),
                    )
                  : _buildDefaultAvatar(),
            ),

            const SizedBox(height: 24),

            // Caller name
            Text(
              callerName,
              style: GoogleFonts.inter(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: Colors.black87,
              ),
              textAlign: TextAlign.center,
            ),

            const SizedBox(height: 8),

            // Call type
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  callType == 'video' ? Icons.videocam : Icons.phone,
                  color: const Color(0xFF06B6D4),
                  size: 20,
                ),
                const SizedBox(width: 8),
                Text(
                  callType == 'video' 
                      ? 'Cuộc gọi video đang đến...' 
                      : 'Cuộc gọi thoại đang đến...',
                  style: GoogleFonts.inter(
                    fontSize: 16,
                    color: Colors.black54,
                  ),
                ),
              ],
            ),

            const SizedBox(height: 32),

            // Action buttons
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                // Decline button (red)
                _buildActionButton(
                  icon: Icons.call_end,
                  label: 'Từ chối',
                  color: Colors.red,
                  onPressed: onDecline,
                ),

                // Accept button (green)
                _buildActionButton(
                  icon: callType == 'video' ? Icons.videocam : Icons.phone,
                  label: 'Chấp nhận',
                  color: Colors.green,
                  onPressed: onAccept,
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDefaultAvatar() {
    return Container(
      width: 120,
      height: 120,
      decoration: const BoxDecoration(
        shape: BoxShape.circle,
        gradient: LinearGradient(
          colors: [
            Color(0xFF2DD4BF),
            Color(0xFF06B6D4),
          ],
        ),
      ),
      child: Center(
        child: Text(
          callerName.isNotEmpty ? callerName[0].toUpperCase() : '?',
          style: GoogleFonts.inter(
            fontSize: 48,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
      ),
    );
  }

  Widget _buildActionButton({
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onPressed,
  }) {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          width: 64,
          height: 64,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: color,
            boxShadow: [
              BoxShadow(
                color: color.withOpacity(0.4),
                blurRadius: 15,
                offset: const Offset(0, 5),
              ),
            ],
          ),
          child: Material(
            color: Colors.transparent,
            child: InkWell(
              onTap: onPressed,
              customBorder: const CircleBorder(),
              child: Center(
                child: Icon(
                  icon,
                  color: Colors.white,
                  size: 32,
                ),
              ),
            ),
          ),
        ),
        const SizedBox(height: 8),
        Text(
          label,
          style: GoogleFonts.inter(
            fontSize: 14,
            fontWeight: FontWeight.w500,
            color: Colors.black54,
          ),
        ),
      ],
    );
  }
}

/// Show incoming call dialog
void showIncomingCallDialog({
  required BuildContext context,
  required String callerName,
  String? callerAvatar,
  String callType = 'video',
  required VoidCallback onAccept,
  required VoidCallback onDecline,
}) {
  showDialog(
    context: context,
    barrierDismissible: false, // Không thể dismiss bằng cách tap outside
    builder: (context) => IncomingCallDialog(
      callerName: callerName,
      callerAvatar: callerAvatar,
      callType: callType,
      onAccept: () {
        Navigator.of(context).pop();
        onAccept();
      },
      onDecline: () {
        Navigator.of(context).pop();
        onDecline();
      },
    ),
  );
}
